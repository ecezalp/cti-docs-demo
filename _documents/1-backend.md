---
title: "backend"
url: "/backend/"
---
# Backend
## Indicator Match Rule
### About
Indicator Match Rule is one of the detection rule types offered by Elastic. The general purpose of an indicator match rule is to create alerts when signatures of known threats are found within a subset of source events. Indicator Match Rules can be used across clusters with caution. Threat matching is an expensive operation and cluster performance degradations have been associated with indicator match rules in the past. Threat documents can be ingested from third party intelligence sources with package integrations through fleet threat intel modules, filebeat threatintel module, or other custom integrations.

### threat_match rule parameters
There are a few rule parameters that are specific to indicator match rules.

|name|description|
|---|---|
|`threat_index`|indices queried to find indicator documents|
|`threat_query`|query made to find the indicator documents|
|`threat_mapping`|definition of which source event field values must match which indicator event field values, supports multiple fields as well as AND and OR combinations|
|`threat_filters`|filters applied to threat_query|
|`threat_language`|language of the threat_query|
|`threat_indicator_path`|object path of enrichment within a single indicator document|
|`concurrent_searches`|number of concurrent searches used during threat_query (defaults to 1, custom values currently unused)|
|`items_per_search`|number of items requested per threat query batch (defaults to 9000, custom values currently unused)|
|`percolate`|(experimental) boolean value to determine whether the percolateExecutor should be used.|

### Architecture
The Indicator Match rule type is created by registering a security rule type with the rule registry plugin on kibana startup. A new rule can then be instantiated through the Create Rule UI or an API call. Just like any other detection rule, continuous rule execution relies on the task manager through the alerting framework. Alerts generated by indicator match rules have `threat.enrichment.*` fields populated with data from the matching indicator documents.

### Executor
The threat match executor is where the specific logic that belongs to an indicator match rule resides. Currently there are two separate executors, threatMatchExecutor and percolateExecutor (experimental).

#### Boolean filter - threatMatchExecutor (7.12+)
With the assumption that customers have more source event documents than indicator documents, the operation starts by obtaining indicator documents in batches of 9000 that satisfy the threat_query. Found indicator documents are then converted into filters for querying the events index to obtain matching events. Any resulting event hits are then enriched with the respective threats (facilitated by the identifiers baked into the named query, indicators must be requested again for threat.indicator.* fields), and are written to the alerts index with a bulkCreate operation.
<img style="max-width:1200px;" src="https://ecezalp.github.io/cti-docs-demo/public/images/threat_match_executor.png"/>

#### Reverse join - threatMatchExecutor(8.2+)
The assumption that the customers have more source event documents than indicator documents has been challenged in a number of SDH issues. To remediate, instead of obtaining indicators to convert them into queries for the events index, event counts and indicator counts are compared at the beginning of the rule execution, and the boolean filter implementation is then applied to the group of hits that has the smaller number of documents. If no documents are found with the count queries, the rule execution is skipped.

#### Percolator - percolateExecutor (8.2+)
Percolator queries have been suggested for performance improvements as an alternate way of executing the rule. More information about how the percolate queries are used can be found in this document. https://docs.google.com/document/d/1QyU-AXcpUfNLyhw--_QyXPqaL2wjCeB2oRWgmC1Quuo/edit#heading=h.w89jskll7q8n
<img style="max-width:1200px;" src="https://ecezalp.github.io/cti-docs-demo/public/images/percolate_executor.png"/>

## Investigation Time Enrichments
### About
Investigation time enrichments are pieces of information displayed as a part of an alert in the alert details flyout. Unlike threat match enrichments (placed onto alerts during the indicator match rule execution) investigation time enrichments are not persisted onto the alert. A search query looking for relevant indicators is triggered when the alert details flyout is opened with a click. The results of the query is displayed in the threat intel tab as an enrichment. Investigation time enrichments can be found on any alert (not just ones that are created by indicator match rules)

### Architecture & available fields
The following source event fields are matched against the following threat indicator fields found in the defaultThreatIndex Kibana UI setting. The detection engine or the alerting framework is not involved, only a custom search strategy is used to execute an elasticsearch query.

|source event field|indicator event field|
|---|---|
|`file.hash.md5`|`threat.indicator.file.hash.md5`|
|`file.hash.sha1`|`threat.indicator.file.hash.sha1`|
|`file.hash.sha256`|`threat.indicator.file.hash.sha256`|
|`file.pe.imphash`|`threat.indicator.file.pe.imphash`|
|`file.elf.telfhash`|`threat.indicator.file.elf.telfhash`|
|`file.hash.ssdeep`|`threat.indicator.file.hash.ssdeep`|
|`source.ip`|`threat.indicator.ip`|
|`destination.ip`|`threat.indicator.ip`|
|`url.full`|`threat.indicator.url.full`|
|`registry.path`|`threat.indicator.registry.path`|

### Comparison of enrichment logic

With indicator match rules, enrichments are made before the alerts are created, and they are persisted along with the alert.
<img style="max-width:900px;" src="/public/images/events.png"/>
<br/>
With investigation time enrichments, enrichments are done after the alert has been created, and the enrichments are not persisted.
<img style="max-width:900px;" src="/public/images/alerts.png"/>

## ECS threat.* fields

### About
ECS [documentation](https://www.elastic.co/guide/en/ecs/current/ecs-threat.html#:~:text=Threat%20Fieldsedit,within%20a%20common%20taxonomy) is the source of truth for `threat.*` fields. An indicator document usually has many other fields such as `agent.*`, `event.*`, and more. For enrichment purposes however, `threat.*` fields are used exclusively. Specifically, when an indicator document is identified as matching a source event, the source event is enriched in the following manner: `threat.indicator.*` fields from the indicator are copied and placed in `threat.enrichments` array on the event, which is then persisted as an alert.

### threat.enrichments.matched.* fields
When the enrichment process takes place, a match object is created with the following values:

|---|---|
|`threat.enrichments.matched.id`|unique id of the indicator document on obtained from the threat index|
|`threat.enrichments.matched.index`|threat index where the indicator document is found|
|`threat.enrichments.matched.field`|the field on the indicator where the match has taken place|
|`threat.enrichments.matched.atomic`|the value of the matched field|
|`threat.enrichments.matched.type`|enum that shows how the enrichment is obtained, where values can be ‘indicator_match_rule’ or “investigation_time”|

### threat.feed.* fields
`threat.feed.*` fields have metadata around the feed, we use `threat.feed.name` and `threat.feed.dashboard_id` to populate the UI in the CTI card.

## threat_indicator_path
`threat_indicator_path` is a rule parameter for the source path of the threat data, and it is used to override the default threat.indicator value during the enrichments process. This is especially useful as historically in filebeat 7* there were fields such as threatintel.indicator, which is the default value for then. We can easily override that, or any other place in any other index, with the threat indicator path. All threat data has to be in one place though, so even in a custom index, if there is file.hash.md5 under custom.test, and threat.indicator.path is custom.test, and there is file.hash.xyz under custom.test2, only the correct path one can be added onto the alert as the enrichment.


## CTI constants
There is a number of constants used throughout the security solution with regards to CTI. this section explains the use of those constants and why the decision to use specific values have been made.

### max_signals rule parameter
The detection engine generates only a specific number of alerts during a single rule execution. The default value is 100, which can be modified by setting the maxSignals parameter on the rule via the Create Rule / Patch Rule API. maxSignals parameter can not be set from the Create Rule UI.

### 9000 as the default threat batch
When threat filters are getting constructed as a part of the boolean filter implementation within the threat match executor, indicators are obtained in batches of 9000. Elasticsearch documentation suggests no more than 10000 items per a single search, and encourages smaller sizes for better performance. 9000 has been chosen without performance testing, which means that there might be an opportunity for improvement here.

### defaultIndex Kibana UI setting
Multiple indices are specified by default as the value of this setting, and they are filled into the “index” input within the first step of the Create Rule UI. Left unchanged, these indices will be queried during the rule execution for source events.

### defaultThreatIndex UI setting

Default threat index is provided by elastic to create an out-of-the-box experience for threat intelligence features in Elastic Security. With the 8.0 release, logs-ti_* index, which is the index pattern corresponding to fleet integration packages, is the default value. Prevously filebeat* has been used as the filebeat threatintel modules were the suggested way of obtaining threatintel in elastic. Default threat index value can be modified through the UI by going to Stack Management / Kibana Advanced Settings and searching for defaultThreatIndex.

Similar to the defaultIndex UI setting, the value of the defaultThreatIndex is used in the first step of the Create Rule UI, this time for filling out the value of the “indicator index” input. Additionally there are several other places where the defaultThreatIndex values are used as the source index for the indicator events, such as the CTI card on the Overview page, and the indices queried for investigation time enrichments.

### Default indicator index query
Default indicator index query is hardcoded into kibana, with a value `'@timestamp >= "now-30d/d"'`. The specific purpose of this query is to ensure that by default, the indicator documents are limited to events that have been ingested within the past 30 days - since having a high number of indicator documents impacts rule execution performance negatively, and recency of indicator documents is an important factor in alert prioritization.

Investigation time enrichments also have concept around the 30 day lookup for the indicator documents. The indicator index query is not visible on the UI as an input field, but there is a Calendar UI that can be used to modify the lookback time for indicators, so an alert can be examined for investigation time enrichments for a specific campaign that may have taken place in the past, even if no investigation time enrichments show up on the alert for the specific -30d window.


## Indicator Match Rule Preview
### About
Indicator match rule preview feature is created to ensure that an indicator match rule can be viewed through the preview UI as a part of the create rule flow define step. The most important part of the preview is to surface errors and warnings to the UI before the rule is created, so that if there are any issues with the rule configuration, the issues could be identified before the rule is actually created. In the future, warnings that are specific to indicator match rules (such as “too many events” or “too many indicators” to encourage the users to use the index query and threat query more effectively are considered.

### Architecture & parameters
The indicator match rule preview uses the threat match executor, and is thus a close approximation of the rule execution (as it is not a search strategy used to simulate the rule execution, but the rule execution itself). However, the alerting framework and the task manager are not a part of the preview implementation. Once a POST request is made to the detection/rules/preview endpoint is made with the appropriate parameters, the threat match executor is used with a preview specific rule data client where the alerts generated are written to a specific space-aware preview index and a unique preview id. The preview UI then queries the preview index with the preview id with a matrix histogram query and displays the results. The preview index has a special ILM policy where it rolls over every day and cleaned every other day.

Since the rule preview is placed at the very beginning of the UI (define step), a lot of the parameters that would could be defined in the later steps are not known by the time that the preview request is triggered. To enable the rule execution some of those required but missing parameters are supplied by default.
- interval: 1h
- from 5min
- advanced settings not supplied
- threat_indicator_path default

#### Limitations

##### Limited number of alerts can be previewed (max_signals constraint)
Detection engine uses a concept called max_signals in general, which means that a single rule execution can only return up to a 100 alerts, and subsequent missing alerts would be picked up with the gap-detection strategy with the next rule execution. However, there is no gap detection strategy with the indicator match rule preview implementation as the rule execution is triggered only once, with the parameters listed above. Therefore indicator match rule can show a preview only up to a 100 alerts in a single preview.

##### Only ECS compliant indices can be previewed (threat_indicator_path constraint)
threat_indicator_path is default as discussed in the parameters sections, which means that the threat matching can not happen with a custom indicator path, which means that preview won’t return results otherwise as the executor can’t go ahead with the enrichment step (should this be skipped for preview?)

##### Performance concerns
Indicator match rules have been disabled at 8.0.0 as the single rule execution can take many seconds even with the most barebones implementation. There is no inherent mechanism to stop the rule execution if it starts taking a really long time, and it can clog up the system with no remediation strategy other than restarting the server if it starts hanging due to a huge query execution time. Given the circumstances the preview functionality has not been deemed production-ready at this time.


## Prebuilt Indicator Match Rules
### About
Prebuilt rules are built by the elastic protections team so that customers can start enabling it immediately and they can have an out of the box experience with threat intelligence in their platform. The rules are created with the latest information and the important techniques. Up until 7 there was only the filebeat rule, which have resulted in a lot of SDHs. In the 8 release we have opted to ship multiple rules so that they can be disabled at will if any of them start behaving badly.

### Threat Intel Indicator Match
This rule queries the `logs_ti*` index pattern to find indicators that have been ingested by Fleet threat intelligence packages. 

### Threat Intel Filebeat Module (v8.x) Indicator Match
This rule queries the `filebeat-8*` index pattern to find indicators that have been ingested by filebeat threatintel module. Filebeat 8.x is ECS 1.11 compliant, with threat.* fields.

### Threat Intel Filebeat Module (v7.x) Indicator Match (deprecated)
This rule queries the `filebeat-*` index pattern to find indicators that have been ingested by filebeat threatintel module. Filebeat 7.x is not ECS 1.11 compliant, and has threatintel.* fields instead of threat.* fields. Therefore, threat_indicator_path is set as threatintel.indicator in the rule configuration.





















































