---
title: "backend"
url: "/backend/"
---
# backend
## Indicator match rule
### about
Indicator Match Rule is one of the detection rule types offered by Elastic. The general purpose of an indicator match rule is to create alerts when signatures of known threats are found within a subset of events. Indicator Match Rules can be used across clusters with caution. Threat matching is an expensive operation and cluster performance degradations have been associated with indicator match rules in the past. Threat documents can be ingested from third party intelligence sources with package integrations through fleet, filebeat threatintel modules, or other custom integrations.

### architecture
The Indicator Match rule type is created by registering a security rule type on the rule registry plugin with the threat match executor on kibana startup. A new rule can then be instantiated through the Create Rule UI or an API call. Just like any other detection rule, continuous rule execution relies on the task manager through the alerting framework. Alerts generated by indicator match rules have threat.enrichment* fields populated. Enrichments are created during the rule execution, and they consist of pieces of the indicator documents placed on the relevant alerts.

### executor
The threat match executor is where the specific logic belonging to an indicator match rule resides. Historically there have been a variety of techniques used for indicator matching within the threat match executor.

#### boolean filter (7.12 - 8.1)
With the assumption that customers have more events than indicator documents, the operation starts by obtaining indicator documents that satisfy the threat_query. The indicator documents that are found are then converted into filters in batches of 9000. The filters are used to query the events index to obtain events that match the found threats. Any resulting hits are then enriched with the respective threats (facilitated by the identifiers baked into the named query), and are written to the alerts index with a bulkCreate operation.

#### reverse join (8.1+)
The assumption that the customers have more indicator documents than events have been proven false in a number of SDH issues. To remediate, both event counts according to index_query and threat counts according to threat_query are obtained at first. The boolean filter implementation is then applied to the group of hits that has the smaller number of documents. If no documents are found with the count queries, the rule execution is skipped.

#### percolator (8.2+)
Percolator queries have been suggested for performance improvements as the boolean filter implementation could create extremely large queries that users have complained about in SDHs.

## investigation time enrichments
### about
Investigation time enrichments is the result of a threat matching strategy that is independent from the alerting framework and rule execution. Investigation time enrichments are created while an analyst is looking through the details of an existing alert that may have been created by any rule (not just indicator match rule). If the examined alert has any matching threats on a predefined list of fields, `threat.enrichments*` fields are accordingly placed on the UI along with the rest of the alert details. Investigation time enrichments are not persisted.

### architecture
Values of the available fields are obtained from the event, and are used in a filter query on the default threat index to find any matching threats. The search strategy limits the indicators searched with a time query of thirty days by default. The search query can not be modified or disabled. But the date can be modified through the calendar UI.

### available fields
- file.hash.md5 <—> threat.indicator.file.hash.md5
- file.hash.sha1 <—> threat.indicator.file.hash.sha1
- file.hash.sha256
- source.ip
- domain.ip
- url.full

## default_Threat_index UI setting
### about
Default threat index is provided by elastic to create an out-of-the-box experience for threat intelligence features in Elastic Security. With the 8.0 release, logs-ti_* index, which is the index pattern corresponding to fleet integration packages, is the default value. Prevously filebeat* has been used as the filebeat threatintel modules were the suggested way of obtaining threatintel in elastic. Default threat index value can be modified through the UI by going to Stack Management / Kibana Advanced Settings and searching for defaultThreatIndex.

### Placements
- indicator match rule default value for threat_index
- investigation time enrichments value for threat index
- CTI card

## default_threat_query / default from
### About
Default threat query has been created to ensure that indicator documents are narrowed down for threat matching. The product decision to limit indicator documents by a month has been made as indicators are time sensitive and more relevant as they are closer to the current time. The purpose of narrowing down the number of documents is to improve threat matching performance.

### placements
- indicator match rule default value for threat_query
- investigation time enrichments value for calendar UI

## Indicator match rule preview
### about
Indicator match rule preview feature is created to ensure that the indicator match rule that is desired to be created can be viewed through the preview UI as a part of the create rule flow define step. The most important part of the preview is to surface errors and warnings to the UI before the rule is created, so that if there are any issues with the rule configuration, the issues could be identified before the rule is actually created in production. In the future, warnings that are specific to indicator match rules (such as “too many events” or “too many indicators” to encourage the users to use the index query and threat query more effectively are considered.

### architecture
The indicator match rule preview uses the threat match executor, and is thus a close approximation of the rule execution (as it is not a search strategy used to simulate the rule execution, but the rule execution itself). However, the alerting framework and the task manager are not a part of the preview implementation. Once a POST request is made to the detection/rules/preview endpoint is made with the appropriate parameters, the threat match executor is used with a preview specific rule data client where the alerts generated are written to a specific space-aware preview index and a unique preview id. The preview UI then queries the preview index with the preview id with a matrix histogram query and displays the results. The preview index has a special ILM policy where it rolls over every day and cleaned every other day.

#### parameters
Since the rule preview is placed at the very beginning of the UI (define step), a lot of the parameters that would could be defined in the later steps are not known by the time that the preview request is triggered. To enable the rule execution some of those required but missing parameters are supplied by default.
- interval: 1h
- from 5min
- advanced settings not supplied
- threat_indicator_path default

#### limitations

##### limited number of alerts can be previewed (max_signals constraint)
Detection engine uses a concept called max_signals in general, which means that a single rule execution can only return up to a 100 alerts, and subsequent missing alerts would be picked up with the gap-detection strategy with the next rule execution. However, there is no gap detection strategy with the indicator match rule preview implementation as the rule execution is triggered only once, with the parameters listed above. Therefore indicator match rule can show a preview only up to a 100 alerts in a single preview.

##### only ECS compliant indices can be previewed (threat_indicator_path constraint)
threat_indicator_path is default as discussed in the parameters sections, which means that the threat matching can not happen with a custom indicator path, which means that preview won’t return results otherwise as the executor can’t go ahead with the enrichment step (should this be skipped for preview?)

### Performance concerns
Indicator match rules have been disabled at 8.0.0 as the single rule execution can take many seconds even with the most barebones implementation. There is no inherent mechanism to stop the rule execution if it starts taking a really long time, and it can clog up the system with no remediation strategy other than restarting the server if it starts hanging due to a huge query execution time. Given the circumstances the preview functionality has not been deemed production-ready at this time.

## ECS fields
### about
ECS fields are used to standardize the data format of elastic search indice schemas so that we can build products with some proedictability. Normally they are used internally, but if a user wants to add a new threat index, or a new threat feed, for best purposes they should absolutely use the latest ECS at all times, and update their indices according to the latest specs every time there is a release update, to ensure that the features work properly and there is no random data missing.

### threat.indicator*
threat.indicator fields are meant for the indicator documents, and it contains information such as file hashes, ip addresses, it’s for source events.

### threat.enrichments*
threat.enrichment fields are meant to be on the alerts and it’s once the enrichments are added on the threats that the indicators show up on the alerts, they are basically the same as the threat.indicator fields.

### threat.feed*
threat.feed has some metadata around the feed, we use threat.feed.name and threat.feed.dashboard_id to populate the UI in the CTI card.

### threat_indicator_path
thraet.indicator.path is the source path of the threat data, and it is used to override the default threat.indicator value during the enrichments process. This is especially useful as historically in filebeat 7* there were fields such as threatintel.indicator, which is the default value for then. We can easily override that, or any other place in any other index, with the threat indicator path. All threat data has to be in one place though, so even in a custom index, if there is file.hash.md5 under custom.test, and threat.indicator.path is custom.test, and there is file.hash.xyz under custom.test2, only the correct path one can be added onto the alert as the enrichment.

## prebuilt indicator match rules
### about
Prebuilt rules are built by the elastic protections team so that customers can start enabling it immediately and they can have an out of the box experience with threat intelligence in their platform. The rules are created with the latest information and the important techniques. Up until 7 there was only the filebeat rule, which have resulted in a lot of SDHs. In the 8 release we have opted to ship multiple rules so that they can be disabled at will if any of them start behaving badly.

### filebeat 7* rule
This rule uses the filebeat data with ECS 1.10 to fulfill the following query.

### filebeat 8* rule
This rule is uses the filebeat data with ECS 1.11 to fulfill the following query.

### fleet 8* rule
This rules the fleet data with the ECS 1.11 to fulfill the following query.

## detection engine key concepts
These are some important concepts that are important for CTI features to exist

### detection rule
Query that executes in intervals until user deactivates the rule.

### alert
Document that gets created when the rule condition is met.

### preview
Alert Document that gets created on a separate preview index that is different than the regular alerts index.

### search strategy
Kibana way of writing a search query.





















































