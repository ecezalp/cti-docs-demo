<!DOCTYPE html>
<html lang="en-us">
<head>
    <link href="http://gmpg.org/xfn/11" rel="profile">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta http-equiv="content-type" content="text/html; charset=utf-8">

    <!-- Enable responsiveness on mobile devices-->
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1">

    <title>
        
         &middot; CTI Onboarding Docs
        
    </title>

    <!-- CSS -->
    <link rel="stylesheet" href="public/css/poole.css">
    <link rel="stylesheet" href="public/css/syntax.css">
    <link rel="stylesheet" href="public/css/blackdoc.css">
    <link rel="stylesheet" href="http://fonts.googleapis.com/css?family=Inter">
    <!-- Icons -->
    <link rel="apple-touch-icon-precomposed" sizes="144x144"
          href="public/apple-touch-icon-144-precomposed.png">
    <link rel="shortcut icon" href="public/security-logo-color.png">

    <!-- RSS -->
    <link rel="alternate" type="application/rss+xml" title="RSS" href="/atom.xml">
</head>
<body>
<div class="banner">
    <div style="background:rgb(18,18,18);border-bottom:5px solid rgb(30,30,30);color:white;font-weight:300;width:100%;height:60px;padding-top:8px;padding-right:20px;text-align:right;font-size:26px;position:fixed;">
    <svg style="height:32px;width:32px;margin-right:12px;margin-bottom:-3px;" xmlns="http://www.w3.org/2000/svg" id="Layer_1" data-name="Layer 1" viewBox="0 0 200 199.22"><defs><style>.cls-1{fill:#fff;}.cls-2{fill:#fec514;}.cls-3{fill:#00bfb3;}.cls-4{fill:#f04e98;}.cls-5{fill:#1ba9f5;}.cls-6{fill:#93c90e;}.cls-7{fill:#07c;}</style></defs><title>glyph-elastic-cluster-color</title><g id="glyph-elastic-cluster-color"><path class="cls-1" d="M200,104.38a39.35,39.35,0,0,0-26-37.12A56.48,56.48,0,0,0,72.72,23.44,30,30,0,0,0,26.24,57.61,39.88,39.88,0,0,0,0,94.87,39.39,39.39,0,0,0,26.15,132.1a57.93,57.93,0,0,0-1,10.74,56.33,56.33,0,0,0,102.13,32.85,30,30,0,0,0,46.51-34.05A39.88,39.88,0,0,0,200,104.38"/><path class="cls-2" d="M78.63,85.8l43.76,20,44.16-38.69a48.79,48.79,0,0,0,.95-9.7,49.35,49.35,0,0,0-90.07-27.9l-7.34,38.1Z"/><path class="cls-3" d="M33.33,132.14a50.16,50.16,0,0,0-1,9.85,49.48,49.48,0,0,0,90.4,27.83l7.29-38-9.72-18.59-43.94-20Z"/><path class="cls-4" d="M33.05,56.41l30,7.08,6.58-34.1a23.71,23.71,0,0,0-36.57,27"/><path class="cls-5" d="M30.45,63.55A33.08,33.08,0,0,0,29,125.87l42.08-38-7.72-16.5Z"/><path class="cls-6" d="M130.46,169.81a23.41,23.41,0,0,0,14.28,4.89,23.71,23.71,0,0,0,22.2-31.85l-30-7Z"/><path class="cls-7" d="M136.55,128l33,7.71a33.37,33.37,0,0,0,22.72-31.41,33,33,0,0,0-21.32-30.85l-43.15,37.8Z"/></g></svg>Elastic Security</div>
    </div>
    <div class="sidebar">
        <div class="container sidebar-sticky">
            <div class="sidebar-about">

                <p class="lead">
                <div class="lead-logo"><a class="home-link" href="">
                        <img src="public/security-logo-color.png"/>
            </a></div>
                <p class="lead"><span>Cyber Threat Intelligence</span> Onboarding Documentation</p>

            </div>
            <nav class="sidebar-nav">
                <pre style="background:none;">
    Backend
    ├── <a href="#indicator-match-rule">Indicator Match Rule</a>
    │   ├── About
    │   ├── threat_match rule parameters
    │   ├── Architecture
    │   └── Executor
    │       ├── Boolean filter (v7.12+)
    │       ├── Reverse join (v8.2+)
    │       └── Percolator (v8.2+)
    ├── <a href="#investigation-time-enrichments">Investigation Time Enrichments</a>
    │   ├── About
    │   └── Architecture & available fields
    │   └── Comparison of enrichment logic
    ├── <a href="#ecs-threat-fields">ECS threat.* fields</a>
    │   ├── About
    │   ├── threat.enrichments.matched.* fields
    │   └── threat.feed.* fields
    ├── <a href="#threat_indicator_path">threat_indicator_path</a>
    ├── <a href="#cti-constants">CTI constants</a>
    │   ├── max_signals rule parameter
    │   ├── 9000 as the default threat batch count
    │   ├── defaultIndex Kibana UI Setting
    │   ├── defaultThreatIndex Kibana UI Setting
    │   └── default indicator index query
    ├── <a href="#indicator-match-rule-preview">Indicator Match Rule Preview</a>
    │   ├── About
    │   ├── Architecture & parameters
    │   └── Limitations
    └──<a href="#prebuilt-indicator-match-rules">Prebuilt Indicator Match Rules</a>
        ├── Threat Intel Indicator Match
        ├── Threat Intel Filebeat Module (v8.x) Indicator Match
        └── Threat Intel Filebeat Module (v7.x) Indicator Match (deprecated)

    Frontend
    ├── <a href="#frontend">Indicator Match Rule</a>
    │   ├── Create Rule UI (Define Step)
    │   ├── Create Rule UI (About Step)
    │   ├── Create Rule UI (Schedule Step)
    │   └── Rule Details UI
    ├── <a href="#alert-details-flyout">Alert Details Flyout</a>
    │   ├── Overview tab
    │   └── Threat Intel tab
    ├── <a href="#threat-intelligence-integrations">Threat Intelligence Integrations</a>
    ├── <a href="#threat-intelligence-card">Threat Intelligence Card</a>
    ├── <a href="#cti-dashboards">CTI dashboards</a>
    ├── <a href="#cti-row-renderer">CTI Row Renderer</a>
    ├── <a href="#cti-timeline-template">CTI Timeline template</a>
    └── <a href="#cti-alerts-table-filter">CTI Alerts Table filter</a>

    Development Setup
    ├── <a href="#setting-up-fleet-threat-integrations">Setting up Fleet threat integrations</a>
    ├── <a href="#setting-up-filebeat-threatintel-integrations">Setting up filebeat threatintel integrations</a>
    ├── <a href="#running-security-solution-api-integration-tests">Running Security Solution API Integration tests</a>
    ├── <a href="#running-security-solution-jest-tests">Running Security Solution jest tests</a>
    ├── <a href="#running-security-solution-cypress-tests">Running Security Solution cypress tests</a>
    └── <a href="#useful-security_solution-scripts">Useful security_solution scripts</a>

    performance
    ├── <a href="#indicator-match-rule-troubleshooting">Indicator Match Rule troubleshooting</a>
    │   ├── Reduce the number of indicators
    │   └── Reduce the number of source documents
    ├── <a href="#benchmarking-with-kbn-alert-load">benchmarking with kbn-alert-load</a>
    └── <a href="#rule-execution-timeline-with-apm">Rule Execution Timeline with APM</a>

    manual regression suites
    ├── <a href="#create-an-alert-from-an-indicator-match-rule">Create an alert from an indicator match rule</a>
    ├── <a href="#create-an-investigation-time-enrichment">Create an investigation time enrichment</a>
    ├── <a href="#populate-the-cti-card">Populate the CTI card</a>
    ├── <a href="#view-cti-dashboards">View CTI dashboards</a>
    ├── <a href="#view-the-cti-row-renderer">View the CTI row renderer</a>
    └── <a href="#use-the-cti-timeline-template">Use the CTI timeline template</a>

                </pre>
            </nav>
        </div>
    </div>
    <div class="content container">
        <div class="home"><div class="documents">
  
  <h1 id="backend">Backend</h1>
<h2 id="indicator-match-rule">Indicator Match Rule</h2>
<h3 id="about">About</h3>
<p>Indicator Match Rule is one of the detection rule types offered by Elastic. The general purpose of an indicator match rule is to create alerts when signatures of known threats are found within a subset of source events. Indicator Match Rules can be used across clusters with caution. Threat matching is an expensive operation and cluster performance degradations have been associated with indicator match rules in the past. Threat documents can be ingested from third party intelligence sources with package integrations through fleet threat intel modules, filebeat threatintel module, or other custom integrations.</p>

<h3 id="threat_match-rule-parameters">threat_match rule parameters</h3>
<p>There are a few rule parameters that are specific to indicator match rules.</p>

<table>
  <thead>
    <tr>
      <th>name</th>
      <th>description</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td><code class="language-plaintext highlighter-rouge">threat_index</code></td>
      <td>indices queried to find indicator documents</td>
    </tr>
    <tr>
      <td><code class="language-plaintext highlighter-rouge">threat_query</code></td>
      <td>query made to find the indicator documents</td>
    </tr>
    <tr>
      <td><code class="language-plaintext highlighter-rouge">threat_mapping</code></td>
      <td>definition of which source event field values must match which indicator event field values, supports multiple fields as well as AND and OR combinations</td>
    </tr>
    <tr>
      <td><code class="language-plaintext highlighter-rouge">threat_filters</code></td>
      <td>filters applied to threat_query</td>
    </tr>
    <tr>
      <td><code class="language-plaintext highlighter-rouge">threat_language</code></td>
      <td>language of the threat_query</td>
    </tr>
    <tr>
      <td><code class="language-plaintext highlighter-rouge">threat_indicator_path</code></td>
      <td>object path of enrichment within a single indicator document</td>
    </tr>
    <tr>
      <td><code class="language-plaintext highlighter-rouge">concurrent_searches</code></td>
      <td>number of concurrent searches used during threat_query (defaults to 1, custom values currently unused)</td>
    </tr>
    <tr>
      <td><code class="language-plaintext highlighter-rouge">items_per_search</code></td>
      <td>number of items requested per threat query batch (defaults to 9000, custom values currently unused)</td>
    </tr>
    <tr>
      <td><code class="language-plaintext highlighter-rouge">percolate</code></td>
      <td>(experimental) boolean value to determine whether the percolateExecutor should be used.</td>
    </tr>
  </tbody>
</table>

<h3 id="architecture">Architecture</h3>
<p>The Indicator Match rule type is created by registering a security rule type with the rule registry plugin on kibana startup. A new rule can then be instantiated through the Create Rule UI or an API call. Just like any other detection rule, continuous rule execution relies on the task manager through the alerting framework. Alerts generated by indicator match rules have <code class="language-plaintext highlighter-rouge">threat.enrichment.*</code> fields populated with data from the matching indicator documents.</p>

<h3 id="executor">Executor</h3>
<p>The threat match executor is where the specific logic that belongs to an indicator match rule resides. Currently there are two separate executors, threatMatchExecutor and percolateExecutor (experimental).</p>

<h4 id="boolean-filter---threatmatchexecutor-712">Boolean filter - threatMatchExecutor (7.12+)</h4>
<p>With the assumption that customers have more source event documents than indicator documents, the operation starts by obtaining indicator documents in batches of 9000 that satisfy the threat_query. Found indicator documents are then converted into filters for querying the events index to obtain matching events. Any resulting event hits are then enriched with the respective threats (facilitated by the identifiers baked into the named query, indicators must be requested again for threat.indicator.* fields), and are written to the alerts index with a bulkCreate operation.
<img style="max-width:1200px;" src="https://ecezalp.github.io/cti-docs-demo/public/images/threat_match_executor.png" /></p>

<h4 id="reverse-join---threatmatchexecutor82">Reverse join - threatMatchExecutor(8.2+)</h4>
<p>The assumption that the customers have more source event documents than indicator documents has been challenged in a number of SDH issues. To remediate, instead of obtaining indicators to convert them into queries for the events index, event counts and indicator counts are compared at the beginning of the rule execution, and the boolean filter implementation is then applied to the group of hits that has the smaller number of documents. If no documents are found with the count queries, the rule execution is skipped.</p>

<h4 id="percolator---percolateexecutor-82">Percolator - percolateExecutor (8.2+)</h4>
<p>Percolator queries have been suggested for performance improvements as an alternate way of executing the rule.
<img style="max-width:1200px;" src="https://ecezalp.github.io/cti-docs-demo/public/images/percolate_executor.png" /></p>

<h2 id="investigation-time-enrichments">Investigation Time Enrichments</h2>
<h3 id="about-1">About</h3>
<p>Investigation time enrichments are pieces of information displayed as a part of an alert in the alert details flyout. Unlike threat match enrichments (placed onto alerts during the indicator match rule execution) investigation time enrichments are not persisted onto the alert. A search query looking for relevant indicators is triggered when the alert details flyout is opened with a click. The results of the query is displayed in the threat intel tab as an enrichment. Investigation time enrichments can be found on any alert (not just ones that are created by indicator match rules)</p>

<h3 id="architecture--available-fields">Architecture &amp; available fields</h3>
<p>The following source event fields are matched against the following threat indicator fields found in the defaultThreatIndex Kibana UI setting. The detection engine or the alerting framework is not involved, only a custom search strategy is used to execute an elasticsearch query.</p>

<table>
  <thead>
    <tr>
      <th>source event field</th>
      <th>indicator event field</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td><code class="language-plaintext highlighter-rouge">file.hash.md5</code></td>
      <td><code class="language-plaintext highlighter-rouge">threat.indicator.file.hash.md5</code></td>
    </tr>
    <tr>
      <td><code class="language-plaintext highlighter-rouge">file.hash.sha1</code></td>
      <td><code class="language-plaintext highlighter-rouge">threat.indicator.file.hash.sha1</code></td>
    </tr>
    <tr>
      <td><code class="language-plaintext highlighter-rouge">file.hash.sha256</code></td>
      <td><code class="language-plaintext highlighter-rouge">threat.indicator.file.hash.sha256</code></td>
    </tr>
    <tr>
      <td><code class="language-plaintext highlighter-rouge">file.pe.imphash</code></td>
      <td><code class="language-plaintext highlighter-rouge">threat.indicator.file.pe.imphash</code></td>
    </tr>
    <tr>
      <td><code class="language-plaintext highlighter-rouge">file.elf.telfhash</code></td>
      <td><code class="language-plaintext highlighter-rouge">threat.indicator.file.elf.telfhash</code></td>
    </tr>
    <tr>
      <td><code class="language-plaintext highlighter-rouge">file.hash.ssdeep</code></td>
      <td><code class="language-plaintext highlighter-rouge">threat.indicator.file.hash.ssdeep</code></td>
    </tr>
    <tr>
      <td><code class="language-plaintext highlighter-rouge">source.ip</code></td>
      <td><code class="language-plaintext highlighter-rouge">threat.indicator.ip</code></td>
    </tr>
    <tr>
      <td><code class="language-plaintext highlighter-rouge">destination.ip</code></td>
      <td><code class="language-plaintext highlighter-rouge">threat.indicator.ip</code></td>
    </tr>
    <tr>
      <td><code class="language-plaintext highlighter-rouge">url.full</code></td>
      <td><code class="language-plaintext highlighter-rouge">threat.indicator.url.full</code></td>
    </tr>
    <tr>
      <td><code class="language-plaintext highlighter-rouge">registry.path</code></td>
      <td><code class="language-plaintext highlighter-rouge">threat.indicator.registry.path</code></td>
    </tr>
  </tbody>
</table>

<h3 id="comparison-of-enrichment-logic">Comparison of enrichment logic</h3>

<p>With indicator match rules, enrichments are made before the alerts are created, and they are persisted along with the alert.
<img style="max-width:900px;" src="https://ecezalp.github.io/cti-docs-demo/public/images/events.png" />
<br />
With investigation time enrichments, enrichments are done after the alert has been created, and the enrichments are not persisted.
<img style="max-width:900px;" src="https://ecezalp.github.io/cti-docs-demo/public/images/alerts.png" /></p>

<h2 id="ecs-threat-fields">ECS threat.* fields</h2>

<h3 id="about-2">About</h3>
<p>ECS <a href="https://www.elastic.co/guide/en/ecs/current/ecs-threat.html#:~:text=Threat%20Fieldsedit,within%20a%20common%20taxonomy">documentation</a> is the source of truth for <code class="language-plaintext highlighter-rouge">threat.*</code> fields. An indicator document usually has many other fields such as <code class="language-plaintext highlighter-rouge">agent.*</code>, <code class="language-plaintext highlighter-rouge">event.*</code>, and more. For enrichment purposes however, <code class="language-plaintext highlighter-rouge">threat.*</code> fields are used exclusively. Specifically, when an indicator document is identified as matching a source event, the source event is enriched in the following manner: <code class="language-plaintext highlighter-rouge">threat.indicator.*</code> fields from the indicator are copied and placed in <code class="language-plaintext highlighter-rouge">threat.enrichments</code> array on the event, which is then persisted as an alert.</p>

<h3 id="threatenrichmentsmatched-fields">threat.enrichments.matched.* fields</h3>
<p>When the enrichment process takes place, a match object is created with the following values:</p>

<table>
  <tbody>
    <tr>
      <td><code class="language-plaintext highlighter-rouge">threat.enrichments.matched.id</code></td>
      <td>unique id of the indicator document on obtained from the threat index</td>
    </tr>
    <tr>
      <td><code class="language-plaintext highlighter-rouge">threat.enrichments.matched.index</code></td>
      <td>threat index where the indicator document is found</td>
    </tr>
    <tr>
      <td><code class="language-plaintext highlighter-rouge">threat.enrichments.matched.field</code></td>
      <td>the field on the indicator where the match has taken place</td>
    </tr>
    <tr>
      <td><code class="language-plaintext highlighter-rouge">threat.enrichments.matched.atomic</code></td>
      <td>the value of the matched field</td>
    </tr>
    <tr>
      <td><code class="language-plaintext highlighter-rouge">threat.enrichments.matched.type</code></td>
      <td>enum that shows how the enrichment is obtained, where values can be ‘indicator_match_rule’ or “investigation_time”</td>
    </tr>
  </tbody>
</table>

<h3 id="threatfeed-fields">threat.feed.* fields</h3>
<p><code class="language-plaintext highlighter-rouge">threat.feed.*</code> fields have metadata around the feed, we use <code class="language-plaintext highlighter-rouge">threat.feed.name</code> and <code class="language-plaintext highlighter-rouge">threat.feed.dashboard_id</code> to populate the UI in the CTI card.</p>

<h2 id="threat_indicator_path">threat_indicator_path</h2>
<p><code class="language-plaintext highlighter-rouge">threat_indicator_path</code> is a rule parameter for the source path of the threat data, and it is used to override the default threat.indicator value during the enrichments process. This is especially useful as historically in filebeat 7* there were fields such as threatintel.indicator, which is the default value for then. We can easily override that, or any other place in any other index, with the threat indicator path. All threat data has to be in one place though, so even in a custom index, if there is file.hash.md5 under custom.test, and threat.indicator.path is custom.test, and there is file.hash.xyz under custom.test2, only the correct path one can be added onto the alert as the enrichment.</p>

<h2 id="cti-constants">CTI constants</h2>
<p>There is a number of constants used throughout the security solution with regards to CTI. this section explains the use of those constants and why the decision to use specific values have been made.</p>

<h3 id="max_signals-rule-parameter">max_signals rule parameter</h3>
<p>The detection engine generates only a specific number of alerts during a single rule execution. The default value is 100, which can be modified by setting the maxSignals parameter on the rule via the Create Rule / Patch Rule API. maxSignals parameter can not be set from the Create Rule UI.</p>

<h3 id="9000-as-the-default-threat-batch">9000 as the default threat batch</h3>
<p>When threat filters are getting constructed as a part of the boolean filter implementation within the threat match executor, indicators are obtained in batches of 9000. Elasticsearch documentation suggests no more than 10000 items per a single search, and encourages smaller sizes for better performance. 9000 has been chosen without performance testing, which means that there might be an opportunity for improvement here.</p>

<h3 id="defaultindex-kibana-ui-setting">defaultIndex Kibana UI setting</h3>
<p>Multiple indices are specified by default as the value of this setting, and they are filled into the “index” input within the first step of the Create Rule UI. Left unchanged, these indices will be queried during the rule execution for source events.</p>

<h3 id="defaultthreatindex-ui-setting">defaultThreatIndex UI setting</h3>

<p>Default threat index is provided by elastic to create an out-of-the-box experience for threat intelligence features in Elastic Security. With the 8.0 release, logs-ti_* index, which is the index pattern corresponding to fleet integration packages, is the default value. Prevously filebeat* has been used as the filebeat threatintel modules were the suggested way of obtaining threatintel in elastic. Default threat index value can be modified through the UI by going to Stack Management / Kibana Advanced Settings and searching for defaultThreatIndex.</p>

<p>Similar to the defaultIndex UI setting, the value of the defaultThreatIndex is used in the first step of the Create Rule UI, this time for filling out the value of the “indicator index” input. Additionally there are several other places where the defaultThreatIndex values are used as the source index for the indicator events, such as the CTI card on the Overview page, and the indices queried for investigation time enrichments.</p>

<h3 id="default-indicator-index-query">Default indicator index query</h3>
<p>Default indicator index query is hardcoded into kibana, with a value <code class="language-plaintext highlighter-rouge">'@timestamp &gt;= "now-30d/d"'</code>. The specific purpose of this query is to ensure that by default, the indicator documents are limited to events that have been ingested within the past 30 days - since having a high number of indicator documents impacts rule execution performance negatively, and recency of indicator documents is an important factor in alert prioritization.</p>

<p>Investigation time enrichments also have concept around the 30 day lookup for the indicator documents. The indicator index query is not visible on the UI as an input field, but there is a Calendar UI that can be used to modify the lookback time for indicators, so an alert can be examined for investigation time enrichments for a specific campaign that may have taken place in the past, even if no investigation time enrichments show up on the alert for the specific -30d window.</p>

<h2 id="indicator-match-rule-preview">Indicator Match Rule Preview</h2>
<h3 id="about-3">About</h3>
<p>Indicator match rule preview feature is created to ensure that an indicator match rule can be viewed through the preview UI as a part of the create rule flow define step. The most important part of the preview is to surface errors and warnings to the UI before the rule is created, so that if there are any issues with the rule configuration, the issues could be identified before the rule is actually created. In the future, warnings that are specific to indicator match rules (such as “too many events” or “too many indicators” to encourage the users to use the index query and threat query more effectively are considered.</p>

<h3 id="architecture--parameters">Architecture &amp; parameters</h3>
<p>The indicator match rule preview uses the threat match executor, and is thus a close approximation of the rule execution (as it is not a search strategy used to simulate the rule execution, but the rule execution itself). However, the alerting framework and the task manager are not a part of the preview implementation. Once a POST request is made to the detection/rules/preview endpoint is made with the appropriate parameters, the threat match executor is used with a preview specific rule data client where the alerts generated are written to a specific space-aware preview index and a unique preview id. The preview UI then queries the preview index with the preview id with a matrix histogram query and displays the results. The preview index has a special ILM policy where it rolls over every day and cleaned every other day.</p>

<p>Since the rule preview is placed at the very beginning of the UI (define step), a lot of the parameters that would could be defined in the later steps are not known by the time that the preview request is triggered. To enable the rule execution some of those required but missing parameters are supplied by default.</p>

<table>
  <tbody>
    <tr>
      <td><code class="language-plaintext highlighter-rouge">interval</code></td>
      <td>1h</td>
    </tr>
    <tr>
      <td><code class="language-plaintext highlighter-rouge">from</code></td>
      <td>5m</td>
    </tr>
    <tr>
      <td><code class="language-plaintext highlighter-rouge">threat_indicator_path</code></td>
      <td><code class="language-plaintext highlighter-rouge">threat.indicator</code></td>
    </tr>
    <tr>
      <td>Advanced Settings</td>
      <td>-</td>
    </tr>
  </tbody>
</table>

<h3 id="limitations">Limitations</h3>

<h5 id="limited-number-of-alerts-can-be-previewed-max_signals-constraint">Limited number of alerts can be previewed (max_signals constraint)</h5>
<p>Detection engine uses a concept called max_signals in general, which means that a single rule execution can only return up to a 100 alerts, and subsequent missing alerts would be picked up with the gap-detection strategy with the next rule execution. However, there is no gap detection strategy with the indicator match rule preview implementation as the rule execution is triggered only once, with the parameters listed above. Therefore indicator match rule can show a preview only up to a 100 alerts in a single preview.</p>

<h5 id="only-ecs-compliant-indices-can-be-previewed-threat_indicator_path-constraint">Only ECS compliant indices can be previewed (threat_indicator_path constraint)</h5>
<p>threat_indicator_path is default as discussed in the parameters sections, which means that the threat matching can not happen with a custom indicator path, which means that preview won’t return results otherwise as the executor can’t go ahead with the enrichment step (should this be skipped for preview?)</p>

<h5 id="performance-concerns">Performance concerns</h5>
<p>Indicator match rules have been disabled at 8.0.0 as the single rule execution can take many seconds even with the most barebones implementation. There is no inherent mechanism to stop the rule execution if it starts taking a really long time, and it can clog up the system with no remediation strategy other than restarting the server if it starts hanging due to a huge query execution time. Given the circumstances the preview functionality has not been deemed production-ready at this time.</p>

<h2 id="prebuilt-indicator-match-rules">Prebuilt Indicator Match Rules</h2>
<h3 id="about-4">About</h3>
<p>Prebuilt rules are built by the elastic protections team so that customers can start enabling it immediately and they can have an out of the box experience with threat intelligence in their platform. The rules are created with the latest information and the important techniques. Up until 7 there was only the filebeat rule, which have resulted in a lot of SDHs. In the 8 release we have opted to ship multiple rules so that they can be disabled at will if any of them start behaving badly.</p>

<h3 id="threat-intel-indicator-match">Threat Intel Indicator Match</h3>
<p>This rule queries the <code class="language-plaintext highlighter-rouge">logs_ti*</code> index pattern to find indicators that have been ingested by Fleet threat intelligence packages.</p>

<h3 id="threat-intel-filebeat-module-v8x-indicator-match">Threat Intel Filebeat Module (v8.x) Indicator Match</h3>
<p>This rule queries the <code class="language-plaintext highlighter-rouge">filebeat-8*</code> index pattern to find indicators that have been ingested by filebeat threatintel module. Filebeat 8.x is ECS 1.11 compliant, with threat.* fields.</p>

<h3 id="threat-intel-filebeat-module-v7x-indicator-match-deprecated">Threat Intel Filebeat Module (v7.x) Indicator Match (deprecated)</h3>
<p>This rule queries the <code class="language-plaintext highlighter-rouge">filebeat-*</code> index pattern to find indicators that have been ingested by filebeat threatintel module. Filebeat 7.x is not ECS 1.11 compliant, and has threatintel.* fields instead of threat.* fields. Therefore, threat_indicator_path is set as threatintel.indicator in the rule configuration.</p>


  
  <h1 id="frontend">Frontend</h1>
<h2 id="indicator-match-rule">Indicator Match Rule</h2>
<h3 id="create-rule-ui-define-step">Create Rule UI (Define Step)</h3>
<p><img style="max-width:1200px;" src="https://ecezalp.github.io/cti-docs-demo/public/images/create_rule_ui.png" /></p>

<ol>
  <li><code class="language-plaintext highlighter-rouge">index</code> &lt;-&gt; Source events are queried from the indices specified with this parameter.</li>
  <li><code class="language-plaintext highlighter-rouge">query</code> &lt;-&gt; Source events are queried with the query specified with this parameter.</li>
  <li><code class="language-plaintext highlighter-rouge">filters</code> &lt;-&gt; Source events are filtered with the filters specified with this parameter.</li>
  <li><code class="language-plaintext highlighter-rouge">threat_index</code> &lt;-&gt; Indicator events are queried from the indices specified with this parameter.</li>
  <li><code class="language-plaintext highlighter-rouge">threat_query</code> &lt;-&gt; Indicator events are queried with the query specified with this parameter.</li>
  <li><code class="language-plaintext highlighter-rouge">threat_mapping</code> &lt;-&gt; Source events and Indicator events are matched on the values specified with this parameter. Multiple mappings can be added with AND and OR buttons.</li>
</ol>

<h3 id="create-rule-ui-about-step">Create Rule UI (About Step)</h3>
<p><img style="max-width:1200px;" src="https://ecezalp.github.io/cti-docs-demo/public/images/create_rule_ui_about.png" />
In the advanced settings section, the value of the <code class="language-plaintext highlighter-rouge">threat_indicator_path</code> parameter can be set on the input titled “Indicator prefix override”. The default value <code class="language-plaintext highlighter-rouge">threat.indicator</code> is ECS 1.11 compliant.</p>

<h3 id="create-rule-ui-schedule-step">Create Rule UI (Schedule Step)</h3>
<p><img style="max-width:1200px;" src="https://ecezalp.github.io/cti-docs-demo/public/images/create_rule_ui_schedule.png" />
The default value for the <code class="language-plaintext highlighter-rouge">schedule</code> parameter is 1h for indicator match rules, and it is recommended to customers not to make the rule execution more frequent to avoid overloading kibana memory.</p>

<h3 id="rule-details-ui">Rule Details UI</h3>
<p><img style="max-width:1200px;" src="https://ecezalp.github.io/cti-docs-demo/public/images/rule_details_ui.png" />
You can find information about the rule parameters in the rule details UI.</p>

<h2 id="alert-details-flyout">Alert Details Flyout</h2>
<h3 id="overview-tab">Overview tab</h3>
<p><img style="max-width:1200px;" src="https://ecezalp.github.io/cti-docs-demo/public/images/alert_details.png" /></p>
<ul>
  <li>section titled “Threat Match Detected” displays the source event field and its value where an <a href="#indicator-match-rule">indicator match rule</a> has added an enrichment onto an alert.</li>
  <li>section titled “Enriched with Threat Intelligence” displays the source event field and its value where an <a href="#investigation-time-enrichments">investigation time enrichment</a> has been added.</li>
</ul>

<h3 id="threat-intel-tab">Threat Intel tab</h3>
<p>Threat Intel tab shows each threat intelligence enrichment associated with the alert.</p>

<p>Enrichments added by the indicator match rule are under the “Threat Match Detected” section. Each enrichment can be collapsed / expanded by clicking on the enrichment title.
<img style="max-width:1200px;" src="https://ecezalp.github.io/cti-docs-demo/public/images/threat_intel_tab_1.png" /></p>

<p>Enrichments added by Investigation Time enrichment logic can be found under the calendar view. The calendar defaults to a 30 day lookup, which can be modified to change the indicator lookup date.
<img style="max-width:1200px;" src="https://ecezalp.github.io/cti-docs-demo/public/images/threat_intel_tab_2.png" /></p>

<h2 id="threat-intelligence-integrations">Threat Intelligence Integrations</h2>
<p>Threat intelligence integrations offered by Fleet can be found on the Integrations page in Kibana. Searching “threat” keyword will yield available threat intel integrations. Fleet Agent must be enabled for ensuring that the indicator events can be ingested. The integrations will populate indices starting with the prefix <code class="language-plaintext highlighter-rouge">logs_ti-*</code>, which is the default  <code class="language-plaintext highlighter-rouge">defaultThreatIndex</code> UI setting value from v8.0 onwards. 
<img style="max-width:1200px;" src="https://ecezalp.github.io/cti-docs-demo/public/images/threat_intel_integrations.png" /></p>

<h2 id="threat-intelligence-card">Threat Intelligence Card</h2>
<p>The Threat Intelligence Card is on the Overview page, and it gives information about the status of the added threat integrations in terms of the indicator events that have been ingested by each integration over the course of the time that has been specified in the top level calendar of the security application.
By default, the Fleet integration API is queried to see if all threat intel integrations have been added via fleet, and if not, a notification is shown to customers to facilitate discovery. The button on the notification takes the users to the Integrations page where the search query “threat” has been applied on the page.
<a href="#cti-constants">defaultThreatIndex UI Setting</a> is queried to find the indicator counts, as it can be inspected with the “Inspect Query” button on the CTI card. <a href="#ecs-threat-fields">threat.feed.name</a> value is used to display the feed name on the UI. For non-ECS compliant data, “Other” is used for a combined indicator count.</p>

<p><img style="max-width:600px;" src="https://ecezalp.github.io/cti-docs-demo/public/images/cti_card.png" /></p>

<h2 id="cti-dashboards">CTI dashboards</h2>
<p>Threat intelligence dashboards links can be found on the Threat Intelligence Card, in the column titled “Source”.</p>

<p>It is also possible to search for threat intelligence dashboards by searching for the “threat intel” tag on the Dashbaords page under the Analyze section of Kibana.
<img style="max-width:1200px;" src="https://ecezalp.github.io/cti-docs-demo/public/images/dashboard_list.png" /></p>

<p>A sample dashboard will have information regarding the status of the indicator index.
<img style="max-width:1200px;" src="https://ecezalp.github.io/cti-docs-demo/public/images/dashboard.png" /></p>

<h2 id="cti-row-renderer">CTI Row Renderer</h2>

<p>CTI row renderer displays relevant threat intelligence information pertaining to an alert when it is viewed on the timeline view. The purpose of the row renderer is to facilitate threat hunting by having the matching threat field and value as well as the threat feed name in a summary view.</p>

<p><img style="max-width:1200px;" src="https://ecezalp.github.io/cti-docs-demo/public/images/row_renderer.png" /></p>

<h2 id="cti-timeline-template">CTI Timeline template</h2>
<p>The generic threat match template allows customers to review alerts with threat intelligence data in a simple way for threat hunting purposes.</p>

<p><img style="max-width:1200px;" src="https://ecezalp.github.io/cti-docs-demo/public/images/timeline_template.png" /></p>

<h2 id="cti-alerts-table-filter">CTI Alerts Table filter</h2>
<p>Alerts table can be filtered to display events that contain threat intelligence information by checking the following checkbox on the table UI. Currently this setting only applies to alerts that have persistent threat intelligence information (alerts that have been created by Indicator Match rules). Investigation time enrichments can not be filtered into this view as the search for those is triggered only in Alert Summary Flyout view only.
<img style="max-width:1200px;" src="https://ecezalp.github.io/cti-docs-demo/public/images/table-filter.png" /></p>

  
  <h1 id="development-setup">Development Setup</h1>

<h2 id="setting-up-fleet-threat-integrations">Setting up Fleet threat integrations</h2>

<ol>
  <li>Install Docker, have a functional Elasticsearch + Kibana instance.</li>
  <li>Add the following lines to <code class="language-plaintext highlighter-rouge">kibana.dev.yaml</code>
<br />
    <div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>xpack.fleet.agents.enabled: true
xpack.fleet.agents.elasticsearch.host: "http://host.docker.internal:9200"
xpack.fleet.agents.fleet_server.hosts: ["http://host.docker.internal:8220"]
</code></pre></div>    </div>
  </li>
  <li>Clone <a href="https://github.com/elastic/integrations">integrations</a> and <a href="https://github.com/elastic/elastic-package">elastic-package</a></li>
  <li>run <code class="language-plaintext highlighter-rouge">make-build</code> in elastic-package</li>
  <li>run <code class="language-plaintext highlighter-rouge">elastic-package stack update</code> in integrations</li>
  <li>confirm profile setup by running <code class="language-plaintext highlighter-rouge">elastic-package profiles list</code> to see a default profile</li>
  <li>update <code class="language-plaintext highlighter-rouge">~/.elastic-package/profiles/default/stack/snapshot.yml</code> to <a href="https://gist.github.com/nkhristinin/73d17b59f52822e194d243732c251d34">this snippet</a></li>
  <li>run Elasticsearch with <code class="language-plaintext highlighter-rouge">yarn es snapshot  -E xpack.security.authc.api_key.enabled=true -E xpack.security.enabled=true -E indices.id_field_data.enabled=true --license trial</code></li>
  <li>run Kibana with <code class="language-plaintext highlighter-rouge">start-kibana</code></li>
  <li>run fleet &amp; elastic-agent with <code class="language-plaintext highlighter-rouge">elastic-package stack up -d --services fleet-server,elastic-agent -v --version=8.0.0-SNAPSHOT</code></li>
</ol>

<p>You can now install a threat integration using the Integrations UI in Kibana. Once you enable a threat integration and assign the default agent policy, you will see that a <code class="language-plaintext highlighter-rouge">logs_ti-*</code> index is created and indicator events are visible in Kibana UI.</p>

<h2 id="setting-up-filebeat-threatintel-integrations">Setting up filebeat threatintel integrations</h2>
<ol>
  <li>start elasticsearch and kibana</li>
  <li>clone <a href="https://github.com/elastic/beats">beats</a></li>
  <li>edit beats/x-pack/filebeat/filebeat.yml
    <ul>
      <li>to include your elasticsearch username and password under output.elasticsearch</li>
      <li>to include kibana username and password under setup.kibana</li>
    </ul>
  </li>
</ol>

<p><em>example</em></p>
<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>// beats/x-pack/filebeat/filebeat.yml
output.elasticsearch:
hosts: ["localhost:9200"]
username: "ece"
password: "testtest"

setup.kibana:  
host: "localhost:5601"
username: "ece"
password: "testtest"
</code></pre></div></div>

<ol>
  <li>run <code class="language-plaintext highlighter-rouge">mage build</code> to build filebeat</li>
  <li>run <code class="language-plaintext highlighter-rouge">./filebeat modules enable threatintel</code> and edit <code class="language-plaintext highlighter-rouge">modules.d/threatintel.yml</code> to ensure that all values for <code class="language-plaintext highlighter-rouge">enabled</code> are <code class="language-plaintext highlighter-rouge">true</code></li>
  <li>run <code class="language-plaintext highlighter-rouge">./filebeat setup -E setup.dashboards.directory=build/kibana</code> to setup dashboards (while kibana is running)</li>
  <li>run <code class="language-plaintext highlighter-rouge">./filebeat -e</code> to start filebeat</li>
</ol>

<p>You will now see that a filebeat index is created and indicator events are visible in kibana.</p>

<h2 id="running-security-solution-api-integration-tests">Running Security Solution API Integration tests</h2>

<ol>
  <li>cd to <code class="language-plaintext highlighter-rouge">kibana</code>, check out the branch you’d like to test, and run <code class="language-plaintext highlighter-rouge">start-bootstrap</code></li>
  <li>If you haven’t done so once, build platform plugins with <code class="language-plaintext highlighter-rouge">node scripts/build_kibana_platform_plugins</code></li>
  <li>run <code class="language-plaintext highlighter-rouge">node scripts/functional_tests --config x-pack/test/detection_engine_api_integration/security_and_spaces/config.ts</code></li>
  <li>if you’d like to run only a subsection of available tests in the <code class="language-plaintext highlighter-rouge">detection_engine_api_integration</code> directory, go through <code class="language-plaintext highlighter-rouge">index.ts</code> file in each subdirectory and comment out the files you’d like to skip.</li>
</ol>

<h2 id="running-security-solution-jest-tests">Running Security Solution jest tests</h2>
<ol>
  <li>cd to <code class="language-plaintext highlighter-rouge">kibana/x-pack</code></li>
  <li>run <code class="language-plaintext highlighter-rouge">node scripts/jest.js</code> and append the directory or file name to run the tests you’d like (such as <code class="language-plaintext highlighter-rouge">node scripts/jest.js percolator</code> to run all files in the percolator directory)</li>
  <li>you can also add <code class="language-plaintext highlighter-rouge">.skip</code> to <code class="language-plaintext highlighter-rouge">describe</code> or <code class="language-plaintext highlighter-rouge">it</code> blocks to skip suites / specs in the targeted files</li>
  <li>use <code class="language-plaintext highlighter-rouge">testing-library</code> instead of <code class="language-plaintext highlighter-rouge">enzyme</code> if you are writing new tests</li>
</ol>

<h2 id="running-security-solution-cypress-tests">Running Security Solution cypress tests</h2>
<ol>
  <li>cd to <code class="language-plaintext highlighter-rouge">kibana/x-pack/plugins/security_solution</code></li>
  <li>run <code class="language-plaintext highlighter-rouge">yarn cypress:open-as-ci</code> to start the cypress UI</li>
  <li>choose any tests you’d like to run from there</li>
</ol>

<h2 id="useful-security_solution-scripts">Useful security_solution scripts</h2>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>
# Elastic aliases
export KIBANA_HOME=$HOME/Workspace/kibana
export PLUGIN_NAME=security_solution
export CASE_PLUGIN_NAME=plugins/case
export NODE_OPTIONS=--max-old-space-size=8192
export filebeat_location=$HOME/go/src/github.com/elastic/beats/x-pack/filebeat
export backport_location=$HOME/.backport/repositories/elastic/kibana

# Start elasticsearch
alias kb-es='cd ${KIBANA_HOME} &amp;&amp; yarn es snapshot -E path.data=${KIBANA_HOME}/../data -E xpack.security.authc.api_key.enabled=true --license trial'

# Start kibana
alias start-kibana='cd $KIBANA_HOME &amp;&amp; yarn start --no-base-path'

# Start bootstrap
alias start-bootstrap='cd $KIBANA_HOME &amp;&amp; yarn kbn bootstrap'

# Start typecheck
alias start-type-check='cd $KIBANA_HOME &amp;&amp; node scripts/type_check.js --project x-pack/tsconfig.json'

# Start ftr
alias start-ftr-server='cd ${KIBANA_HOME}/x-pack &amp;&amp; node scripts/functional_tests_server.js'
alias start-ftr='cd ${KIBANA_HOME}/x-pack &amp;&amp; node scripts/functional_test_runner' 

# Start lint
alias start-lint='cd $KIBANA_HOME &amp;&amp; node scripts/eslint.js'
alias start-lint-siem='cd $KIBANA_HOME &amp;&amp; node scripts/eslint.js x-pack/plugins/$PLUGIN_NAME'
alias start-lint-case='cd $KIBANA_HOME &amp;&amp; node scripts/eslint.js x-pack/plugins/case'

# Start unit tests
alias start-jest='cd $KIBANA_HOME/x-pack &amp;&amp; node scripts/jest.js $PLUGIN_NAME'
alias start-jest-case='cd $KIBANA_HOME/x-pack &amp;&amp; node scripts/jest.js $CASE_PLUGIN_NAME'

# Start unit tests watch
alias start-jest-watch='cd $KIBANA_HOME/x-pack &amp;&amp; node scripts/jest.js $PLUGIN_NAME --watch'
alias start-jest-watch-size='cd $KIBANA_HOME/x-pack &amp;&amp; node --max-old-space-size=8192 --optimize-for-size  --max_old_space_size=8192 --optimize_for_size scripts/jest.js $PLUGIN_NAME --watch --max_new_space_size=8192'
alias start-jest-watch-case='cd $KIBANA_HOME/x-pack &amp;&amp; node scripts/jest.js $CASE_PLUGIN_NAME --watch'

# Start unit tests coverage
alias start-jest-coverage='cd $KIBANA_HOME/x-pack &amp;&amp; node scripts/jest.js $PLUGIN_NAME --coverage'
alias start-jest-coverage-case='cd $KIBANA_HOME/x-pack &amp;&amp; node scripts/jest.js $CASE_PLUGIN_NAME --coverage'

# Start generation
alias start-bean-gen='cd $KIBANA_HOME/x-pack/plugins/$PLUGIN_NAME &amp;&amp; node scripts/generate_types_from_graphql.js'

# Run cyclic dependencies test
alias start-deps-check='cd ${KIBANA_HOME}/x-pack/plugins/${PLUGIN_NAME} &amp;&amp; node scripts/check_circular_deps.js'

# Start api integration tests
alias start-integration='cd $KIBANA_HOME &amp;&amp; node scripts/functional_tests --config x-pack/test/api_integration/config.js'

# Start cypress open
alias start-cypress-open='cd $KIBANA_HOME/x-pack/plugins/$PLUGIN_NAME &amp;&amp; yarn cypress:open'

# Start cypress run
alias start-cypress-run='cd $KIBANA_HOME/x-pack/plugins/$PLUGIN_NAME &amp;&amp; yarn cypress:run'

# Start cypress ci
alias start-cypress-ci='cd $KIBANA_HOME/x-pack/plugins/$PLUGIN_NAME &amp;&amp; yarn cypress:run-as-ci'

# Test all
alias start-test-all='start-bean-gen &amp;&amp; start-i18n-check &amp;&amp; start-type-check &amp;&amp; start-lint &amp;&amp; start-lint-case &amp;&amp; start-jest &amp;&amp; start-jest-case'

# Start a translation check
alias start-i18n-check='cd $KIBANA_HOME &amp;&amp; node scripts/i18n_check --ignore-missing'

# Backport alias
alias start-backport='cd $KIBANA_HOME &amp;&amp; node scripts/backport'

# Delete node_modules and caches
alias start-burn-the-world='cd $KIBANA_HOME &amp;&amp; git clean -fdx -e \.idea\/ -e config\/ &amp;&amp; rm -rf node_modules &amp;&amp; yarn cache clean'

# Sync kibana
alias sync-kibana='cd $KIBANA_HOME &amp;&amp; git checkout main &amp;&amp; git fetch upstream &amp;&amp; git merge upstream/main &amp;&amp; git push origin main'

# Branch Update with Upstream master
alias bru='git fetch upstream &amp;&amp; git pull -r upstream main &amp;&amp; git status'
</code></pre></div></div>

  
  <h1 id="performance">performance</h1>
<h2 id="indicator-match-rule-troubleshooting">Indicator Match Rule Troubleshooting</h2>
<p>Possible issues that have been observed before can be grouped in the following categories:</p>
<h4 id="rules-are-failing-due-to-number-of-alerts">Rules are failing due to number of alerts</h4>

<p>This usually manifests as a rule failure: <code class="language-plaintext highlighter-rouge">Bulk Indexing of signals failed: [parent] Data too large</code>, indicating that the alerts payload was simply too large to process. This could be caused by anything upstream of the alert generation: bad/greedy indicator data, a misconfigured rule, or simply too many events/matches. If nothing obvious is misconfigured, try executing the rule against a subset of the original data and continue diagnosis.</p>

<h4 id="indicator-match-rules-are-timing-out">Indicator match rules are timing out</h4>

<p>This occurs as another rule failure: <code class="language-plaintext highlighter-rouge">An error occurred during rule execution: message: "Request Timeout after 90000ms"</code> and indicates that the query phase is timing out. Similar to the above, inspect the time frame and indices that this rule(s) is querying and try to limit this, or break into multiple rules, etc. See also the General Guidelines below.</p>

<h4 id="general-slowness">General Slowness</h4>

<p>Due to the amount of in-memory work that indicator match rules perform, having a large number of rules running in parallel can cause noticeable performance implications to kibana.</p>

<h3 id="reduce-the-number-of-indicators">Reduce the number of indicators</h3>
<p>Since the number of indicators directly relates to the amount of work to be performed, filtering out unnecessary indicators is a quick way to improve performance. This can most easily be done with the indicator query (rule parameter: threat_query). If, for example, your indicator indices contain two types of data, but your rule is only concerned with one of them, a threat query of <code class="language-plaintext highlighter-rouge">threat.indicator.dataset: “my_dataset”</code> will reduce the number of indicators that must be iterated through.</p>
<h3 id="reduce-the-number-of-source-documents">Reduce the number of source documents</h3>
<p>Similar to the above, narrowing the query (rule parameter: query) of your source indices may also improve performance. If, as above, your mapping includes source.port -&gt; threat.indicator.port, defining a query of source_port: * can help ensure that irrelevant documents are not included in the search.</p>

<h2 id="benchmarking-with-kbn-alert-load">Benchmarking with kbn-alert-load</h2>
<p><a href="https://github.com/elastic/kbn-alert-load">kbn-alert-load</a> is a library for load testing the alerting framework. It is also useful for establishing performance benchmarks for the Indicator Match rule. 
Multiple test cases have been created for measuring the indicator match rule performance.</p>

<table>
  <thead>
    <tr>
      <th>name</th>
      <th>rule count</th>
      <th>rule interval</th>
      <th>indicator count</th>
      <th>event count per minute</th>
      <th>matched field count</th>
      <th>runtime</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td>Case 1</td>
      <td>5</td>
      <td>1m</td>
      <td>10k</td>
      <td>100</td>
      <td>1</td>
      <td>4m</td>
    </tr>
    <tr>
      <td>Case 2</td>
      <td>15</td>
      <td>1m</td>
      <td>10k</td>
      <td>100</td>
      <td>1</td>
      <td>4m</td>
    </tr>
    <tr>
      <td>Case 3</td>
      <td>5</td>
      <td>1m</td>
      <td>1k</td>
      <td>4k</td>
      <td>1</td>
      <td>4m</td>
    </tr>
    <tr>
      <td>Case 4</td>
      <td>5</td>
      <td>1m</td>
      <td>100k</td>
      <td>100</td>
      <td>3</td>
      <td>4m</td>
    </tr>
    <tr>
      <td>Case 5</td>
      <td>10</td>
      <td>1m</td>
      <td>250k</td>
      <td>100</td>
      <td>1</td>
      <td>2m</td>
    </tr>
  </tbody>
</table>

<p>The following are the results comparing the 8.0 and 8.1 branches to one another according to the cases outlined above.</p>

<p><img style="max-width:600px;" src="https://ecezalp.github.io/cti-docs-demo/public/images/benchmark.png" /></p>

<h2 id="rule-execution-timeline-with-apm">Rule execution timeline with APM</h2>
<p>APM is helpful for monitoring the CPU and memory usage while the Indicator Match rules are running, and it provides an important supporting metric to results obtained by kbn-alert-load.</p>

<p>Individual requests can also be observed with APM. The following is the difference between the execution time of an individual query made to the threat index to obtain indicators.</p>

<p><img style="max-width:600px;" src="https://ecezalp.github.io/cti-docs-demo/public/images/apm.png" /></p>

  
  <h1 id="manual-regression-suites">manual regression suites</h1>

<h2 id="create-an-alert-from-an-indicator-match-rule">Create an alert from an indicator match rule</h2>
<ul>
  <li>run Elasticsearch + kibana locally, or deploy a cloud instance</li>
  <li>navigate to Kibana Dev Tools</li>
  <li>create an event index with the following query</li>
</ul>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>PUT test-index
</code></pre></div></div>

<ul>
  <li>add the date mapping for the <code class="language-plaintext highlighter-rouge">@timestamp</code> field</li>
</ul>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>PUT test-index/_mapping
{
  "properties": {
    "@timestamp": {
      "type": "date"
    }
  }
}
</code></pre></div></div>
<ul>
  <li>get a fresh timestamp value by opening the browser javascript console and executing</li>
</ul>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>new Date().valueOf()
</code></pre></div></div>

<ul>
  <li>copy the value (for example, <code class="language-plaintext highlighter-rouge">1645547413852</code>) and make the following request to create a source event. 
Note: in this example, a field named <code class="language-plaintext highlighter-rouge">test-field</code> is added to the event. Indicator Match rules work with all events, but ECS compliant fields are recommended for use.</li>
</ul>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>POST test-index/_doc
{
  "@timestamp": 1645547413852,
  "test-field": "test-value"
}
</code></pre></div></div>

<ul>
  <li>create a threat index with a date type <code class="language-plaintext highlighter-rouge">@timestamp</code> field.</li>
</ul>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>PUT threat-index

PUT threat-index/_mapping
{
  "properties": {
    "@timestamp": {
      "type": "date"
    }
  }
}

PUT threat-index/_doc
{
  "@timestamp": 1645547413852,
  "threat-field": "test-value"
}
</code></pre></div></div>

<ul>
  <li>Create a new indicator match rule, with <code class="language-plaintext highlighter-rouge">test-index</code> as the index value, <code class="language-plaintext highlighter-rouge">threat-index</code> as the threat index value.</li>
  <li>Add <code class="language-plaintext highlighter-rouge">test-field</code> to index field, and <code class="language-plaintext highlighter-rouge">threat-field</code> to indicator field to create the threat mapping.</li>
  <li>Create the rule with a name, description, schedule, and interval.</li>
  <li>Alert will appear on the alerts table once the rule execution is complete.</li>
  <li>For better indicator documents, <a href="#setting-up-fleet-threat-integrations">setup a threat intel integration</a> and use a field from there to match an event.</li>
</ul>

<h2 id="create-an-investigation-time-enrichment">Create an investigation time enrichment</h2>

<h2 id="populate-the-cti-card">Populate the CTI card</h2>

<h2 id="view-cti-dashboards">View CTI dashboards</h2>

<h2 id="view-the-cti-row-renderer">View the CTI row renderer</h2>

<h2 id="use-the-cti-timeline-template">Use the CTI timeline template</h2>

  
</div>
</div>

    </div>
    </body>
    </html>
